rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Allow reading a "health" document for connectivity checks
    match /health/{doc} {
      allow read: if true;
    }

    match /users/{userId} {
      // Allow authenticated users to read any user's basic profile info (needed for collaborator lists)
      // Users can only update their own document
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    match /trips/{tripId} {
      // Helper function to check if user has access to a trip document
      function isTripOwnerOrCollaborator() {
        return request.auth != null && 
          resource != null &&
          (request.auth.uid == resource.data.ownerId || 
           ('collaborators' in resource.data && 
            request.auth.uid in resource.data.collaborators));
      }
      
      function canCreateTrip() {
        return request.auth != null &&
          (request.auth.uid == request.resource.data.ownerId ||
           ('collaborators' in request.resource.data &&
            request.auth.uid in request.resource.data.collaborators));
      }
      
      allow create: if canCreateTrip();
      // User can read, update, or delete a trip if their UID matches ownerId or is in the collaborators array
      // For queries, Firestore evaluates this rule per document
      allow read: if request.auth != null && 
        resource != null &&
        (request.auth.uid == resource.data.ownerId || 
         ('collaborators' in resource.data && 
          request.auth.uid in resource.data.collaborators));
      allow update, delete: if isTripOwnerOrCollaborator();

      match /photos/{photoId} {
        function getTripData() {
          return get(/databases/$(database)/documents/trips/$(tripId)).data;
        }
        
        function userHasTripAccess() {
          let tripData = getTripData();
          return request.auth != null && 
            (request.auth.uid == tripData.ownerId || 
             ('collaborators' in tripData && 
              request.auth.uid in tripData.collaborators));
        }
        
        allow read: if userHasTripAccess();
        allow create, delete: if userHasTripAccess();
      }
    }

    match /bookings/{bookingId} {
      // Helper function to check if user has access to the trip this booking belongs to
      function isTripOwnerOrCollaborator() {
        let tripId = resource.data.tripId;
        let tripDoc = get(/databases/$(database)/documents/trips/$(tripId));
        let tripData = tripDoc.data;
        return request.auth != null &&
          resource != null &&
          'tripId' in resource.data &&
          exists(/databases/$(database)/documents/trips/$(tripId)) &&
          (request.auth.uid == tripData.ownerId ||
           ('collaborators' in tripData && 
            request.auth.uid in tripData.collaborators));
      }
      
      // Users can read their own bookings or bookings for trips they have access to
      allow read: if request.auth != null &&
        resource != null &&
        (request.auth.uid == resource.data.userId ||
         isTripOwnerOrCollaborator());
      
      // Users can create their own bookings
      allow create: if request.auth != null &&
        request.auth.uid == request.resource.data.userId &&
        'tripId' in request.resource.data;
      
      // Users can update/delete their own bookings
      allow update, delete: if request.auth != null &&
        resource != null &&
        request.auth.uid == resource.data.userId;
    }
  }
}
